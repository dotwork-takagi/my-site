<html>

<body>
    <h1>ドッティーをつかまえろ！</h1>
    <span id="gamepoint">
        <span id="current-level">現在: Lv.0</span>
        <span id="max-level">最高: Lv.0</span>
        <span id="time">時間: 30秒</span>
    </span>
    <div id='gamebody'>
        <img src='dotty.svg'>
    </div>
</body>

<style>
    body {
        overflow: hidden;
        user-select: none;
        cursor: url('bone.cur'), default;
    }

    h1 {
        display: inline-block;
    }

    span {
        padding-right: 1em;
    }

    img {
        -webkit-user-drag: none;
    }

    #gamebody {
        height: 80vh;
    }
</style>

<script>

    window.onload = function () {

        let currentLevel = 0
        let maxLevel = 0
        let time = 30

        const body = document.body
        const gamebody = document.querySelector('#gamebody')
        const img = document.querySelector('img')

        let maxX = gamebody.clientWidth - img.clientWidth
        let maxY = gamebody.clientHeight - img.clientHeight

        let x = 0;
        let y = 0;
        let z = 0;
        let dx = 5;
        let dy = 5;

        body.onmousedown = () => {
            if (time != 30 && time != 0) {
                failure()
            }
        }

        img.onmousedown = () => {
            if (time == 30) {
                time = 29
                move()
                setInterval(() => {
                    if (time != 30 && time != 0) {
                        time -= 1
                        if (time == 0) {
                            alert('終了です！')
                        }
                        drawGamepoint()
                    }
                }, 1000);
            }
            if (time != 30 && time != 0) {
                success()
            }
            event.stopPropagation()
        }

        const acceleration = 1.05

        function success() {
            dx = dx * acceleration
            dy = dy * acceleration
            currentLevel += 1
            drawGamepoint()
            SetBgcolorTimer('#d1ffa3') // 薄い緑
        }

        function failure() {
            dx = dx / acceleration
            dy = dy / acceleration
            currentLevel -= 1
            drawGamepoint()
            SetBgcolorTimer('#ffa3a3') // 薄い赤
        }

        function move() {
            if (time != 30 && time != 0) {
                x += dx * 1.0;
                y += dy * 1.0;
                z += 2.5;
                if (x < 0 || x > maxX) {
                    dx *= -1.0;
                }
                if (y < 0 || y > maxY) {
                    dy *= -1.0;
                }
                img.style.transform = `translate(${x}px, ${y}px) rotate(${z}deg)`;
                requestAnimationFrame(move);
            }
        }

        function SetBgcolorTimer(color) {
            body.style.backgroundColor = color
            window.setTimeout(function () {
                body.style.backgroundColor = 'white'
            }, 250)
        }

        function drawGamepoint() {
            if (currentLevel >= maxLevel) {
                maxLevel = currentLevel
            }
            document.querySelector('#current-level').innerHTML = `現在: Lv.${currentLevel}`
            document.querySelector('#max-level').innerHTML = `最大: Lv.${maxLevel}`
            document.querySelector('#time').innerHTML = `時間: ${time}秒`
        }
    }
</script>

</html>