<html>

<body>
    <h1>ドッティーをつかまえろ！</h1>
    <span id="gamepoint">
        <span id="current-level">現在: Lv.0</span>
        <span id="max-level">最高: Lv.0</span>
        <span id="time">時間: 30秒</span>
    </span>
    <div id='gamebody'>
        <img src='dotty.svg'>
    </div>
</body>

<style>
    body {
        overflow: hidden;
        user-select: none;
        cursor: url('bone.cur'), default;
    }

    h1 {
        display: inline-block;
    }

    span {
        padding-right: 1em;
    }

    img {
        -webkit-user-drag: none;
    }

    #gamebody {
        height: 80vh;
    }
</style>

<script>

    window.onload = function () {

        let currentLevel = 0
        let maxLevel = 0
        let time = 30

        const body = document.body
        const gamebody = document.querySelector('#gamebody')
        const img = document.querySelector('img')

        let maxX = gamebody.clientWidth - img.clientWidth
        let maxY = gamebody.clientHeight - img.clientHeight

        let x = 0
        let y = 0
        let z = 0
        let dx = 5
        let dy = 5
        let dz = 2.5

        body.onmousedown = () => {
            if (time != 30 && time != 0) {
                failure() // クリック失敗
            }
        }

        img.onmousedown = () => {
            if (time == 30) {
                time = 29
                move() // ドッティーを動かす
                setInterval(() => { // 時間を動かす
                    if (time != 30 && time != 0) {
                        time -= 1
                        if (time == 0) {
                            alert('終了です！')
                        }
                        drawGamepoint()
                    }
                }, 1000)
            }
            if (time != 30 && time != 0) {
                success() // クリック成功
            }
            event.stopPropagation()
        }

        function move() { // ドッティーを動かす処理
            if (time != 30 && time != 0) {
                x += dx
                y += dy
                z += dz
                if (x < 0 || x > maxX) {
                    dx *= -1
                }
                if (y < 0 || y > maxY) {
                    dy *= -1
                }
                img.style.transform = `translate(${x}px, ${y}px) rotate(${z}deg)`
                requestAnimationFrame(move)
            }
        }

        const acceleration = 1.05 // 加速

        function success() { // クリック成功した時
            dx = dx * acceleration
            dy = dy * acceleration
            currentLevel += 1
            drawGamepoint()
            SetBgcolorTimer('#d1ffa3') // 背景色を薄い緑にする
        }

        function failure() { // クリック失敗した時
            dx = dx / acceleration
            dy = dy / acceleration
            currentLevel -= 1
            drawGamepoint()
            SetBgcolorTimer('#ffa3a3') // 背景色を薄い赤にする
        }

        function SetBgcolorTimer(color) { // 背景色を変える
            body.style.backgroundColor = color
            window.setTimeout(function () {
                body.style.backgroundColor = 'white'
            }, 250)
        }

        function drawGamepoint() { // gamepointを描画する
            if (currentLevel >= maxLevel) {
                maxLevel = currentLevel
            }
            document.querySelector('#current-level').innerHTML = `現在: Lv.${currentLevel}`
            document.querySelector('#max-level').innerHTML = `最大: Lv.${maxLevel}`
            document.querySelector('#time').innerHTML = `時間: ${time}秒`
        }
    }
</script>

</html>